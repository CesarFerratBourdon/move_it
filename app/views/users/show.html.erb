<style type="text/css">
      #map-canvas{
          height: 350px;
          width: 400px;
      }
</style>
<script type="text/javascript">

$(document).ready(newRental);

function newRental () {

    if (localStorage.getItem("new-rental") !== null) {

      var newRental = JSON.parse(localStorage.getItem("new-rental"));
      console.log(newRental);
      calcRoute(newRental);
    };
}

var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;

function calcRoute(newRental) {
  console.log(newRental.lat1);

  directionsDisplay = new google.maps.DirectionsRenderer();
  var chicago = new google.maps.LatLng(41.850033, -87.6500523);
  var mapOptions = {
    zoom:2,
    center: chicago,
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  directionsDisplay.setMap(map);

  var request = {
      origin: new google.maps.LatLng(newRental.lat1,newRental.lng1),
      destination: new google.maps.LatLng(newRental.lat2,newRental.lng2),
      travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });

  var service = new google.maps.DistanceMatrixService();
    service.getDistanceMatrix({
        origins: [new google.maps.LatLng(newRental.lat1,newRental.lng1)],
        destinations: [new google.maps.LatLng(newRental.lat2,newRental.lng2)],
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC,
        avoidHighways: false,
        avoidTolls: false
    }, function (response, status) {
        if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
            var distance = response.rows[0].elements[0].distance.text;
            var divDistance = document.getElementById("divDistance");
           divDistance.innerHTML = "";
           divDistance.innerHTML += "Distance: " + distance + "<br />";
           var rental = {}
           rental["distance"] = response.rows[0].elements[0].distance.value;
           rental["piano"] = newRental.piano
           rental["city1"] = newRental.city1
           rental["city2"] = newRental.city2
           rental["size_living"] = newRental.size_living
           rental["size_basement"] = newRental.size_basement
          //  saveRental(rental);
          calculatePricing(rental);

        } else {
            alert("Unable to find the distance via road.");
        }
    });
}

function calculatePricing(rental){
    var request = $.get('/users/<%=current_user.id%>/calculatepricing', rental);

        function onSaveSuccess (response) {
          console.debug('Quote calculated!', response);
          localStorage.removeItem("new-rental");
        }

        function onSaveFailure (err) {
         console.error(err.responseJSON);
        }

    request.done(onSaveSuccess);
    request.fail(onSaveFailure);

}

// function saveRental(rental){
//     var request = $.post('/users/<%=current_user.id%>/createrental', rental);
//
//         function onSaveSuccess (response) {
//           console.debug('saved!', response);
//           localStorage.removeItem("new-rental");
//         }
//
//         function onSaveFailure (err) {
//          console.error(err.responseJSON);
//         }
//
//     request.done(onSaveSuccess);
//     request.fail(onSaveFailure);
//
// }

</script>

<div class="col-lg-4">
</div>
  <div class="col-lg-5">
    <a href="/users/<%=current_user.id%>/quote" class="btn btn-primary">Get a new quote</a>
    <a href="/" class="btn btn-primary">Payment</a>
    <a href="/" class="btn btn-primary">Settings</a>
    <a href="/" class="btn btn-primary">Edit profile</a>
  </div>
<div class="col-lg-3">
</div>

      <div class="row">
					<div class="container">
						<div id="map-canvas"></div>
            <div id="divDistance"></div>
					</div>
			</div>

      <div class="row">
        <div class="col-lg-4">
        </div>
        <div class="col-lg-5">
          <h2>History of past quotes:</h2><br>
					<div class="container">
						<% @rentals.each do |rental| %>
            <%= rental.city1 %><br>
            <% end %>
					</div>
        </div>
        <div class="col-lg-3">
        </div>
			</div>
